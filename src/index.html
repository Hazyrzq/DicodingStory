<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Dicoding Story" />
    <link rel="apple-touch-icon" href="favicon.png" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="styles/styles.css" />
    <title>App</title>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module" src="scripts/index.js"></script>
    <script>
      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }

      // PWA Install prompt handler
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const btn = document.getElementById('install-btn');
        if (btn) btn.style.display = 'inline-flex';
      });
      window.addEventListener('appinstalled', () => {
        const btn = document.getElementById('install-btn');
        if (btn) btn.style.display = 'none';
        deferredPrompt = null;
        console.log('PWA installed');
      });
      window.installApp = async function(){
        const btn = document.getElementById('install-btn');
        // If prompt is available, use it; otherwise show guidance
        if (!deferredPrompt) {
          alert('Untuk memasang aplikasi: klik ikon Install di address bar atau buka menu Chrome → Install app.');
          return;
        }
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; } catch {}
        deferredPrompt = null;
        if (btn) btn.style.display = 'none';
      }
      // If already running as installed app, hide button
      if (window.matchMedia('(display-mode: standalone)').matches) {
        const btn = document.getElementById('install-btn');
        if (btn) btn.style.display = 'none';
      }
    </script>
  </head>
  <body>
    <header>
      <a href="#main-content" class="skip-link" tabindex="1">Skip to content</a>
      <div class="main-header container">
        <a class="brand-name" href="#/">Dicoding Story</a>
        <button id="install-btn" class="btn" style="display:none; margin-right:8px"><i class="fas fa-download"></i> Install</button>
        <nav id="navigation-drawer" class="navigation-drawer" style="margin-left:auto;">
          <ul id="nav-list" class="nav-list">
            <li><a href="#/"><i class="fas fa-home"></i> Beranda</a></li>
            <li><a href="#/offline-stories" id="nav-offline-stories" style="display:none;"><i class="fas fa-database"></i> Offline Stories</a></li>
            <li><a href="#/login"><i class="fas fa-sign-in-alt"></i> Login</a></li>
            <li><a href="#/register"><i class="fas fa-user-plus"></i> Register</a></li>
            
            <li><button id="logout-btn" class="btn" style="display:none;"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
          </ul>
        </nav>
        <button id="drawer-button" class="drawer-button">☰</button>
      </div>
    </header>

    <main id="main-content" class="main-content" tabindex="-1"></main>
    
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>Dicoding Story</h3>
            <p>Platform berbagi cerita terbaik untuk komunitas developer Indonesia</p>
          </div>
          <div class="footer-section">
            <h4>Navigasi</h4>
            <ul>
              <li><a href="#/">Beranda</a></li>
              <li><a href="#/login" id="footer-login">Login</a></li>
              <li><a href="#/register" id="footer-register">Register</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>Fitur</h4>
            <ul>
              <li>Bagikan Cerita</li>
              <li>Lokasi Interaktif</li>
              <li>Notifikasi Push</li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2024 Dicoding Story. Dibuat dengan ❤️ untuk komunitas developer Indonesia.</p>
        </div>
      </div>
    </footer>
    <!-- Mobile Skip FAB -->
    <a href="#main-content" class="skip-fab" aria-label="Skip to content" title="Skip to content">
      <i class="fas fa-forward"></i>
    </a>
    <script>
      (function(){
        const logoutBtn = document.getElementById('logout-btn');
        const navList = document.getElementById('nav-list');
        function updateAuthLinks(){
          const token = localStorage.getItem('auth_token');
          const loginLink = navList.querySelector('a[href="#/login"]');
          const registerLink = navList.querySelector('a[href="#/register"]');
          const offlineStoriesLink = document.querySelector('#nav-offline-stories');
          const footerLogin = document.querySelector('#footer-login');
          const footerRegister = document.querySelector('#footer-register');
          
          if(token){
            if(loginLink) loginLink.style.display = 'none';
            if(registerLink) registerLink.style.display = 'none';
            if(offlineStoriesLink) offlineStoriesLink.style.display = '';
            if(footerLogin) footerLogin.style.display = 'none';
            if(footerRegister) footerRegister.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
          } else {
            if(loginLink) loginLink.style.display = '';
            if(registerLink) registerLink.style.display = '';
            if(offlineStoriesLink) offlineStoriesLink.style.display = 'none';
            if(footerLogin) footerLogin.style.display = 'block';
            if(footerRegister) footerRegister.style.display = 'block';
            logoutBtn.style.display = 'none';
          }
        }
        updateAuthLinks();
        window.addEventListener('hashchange', updateAuthLinks);
        logoutBtn?.addEventListener('click', function(){
          localStorage.removeItem('auth_token');
          updateAuthLinks();
          location.hash = '#/login';
        });
      })();

      // Skip to content functionality
      document.addEventListener('DOMContentLoaded', function() {
        const skipLink = document.querySelector('.skip-link');
        const mainContent = document.querySelector('#main-content');
        
        if (skipLink && mainContent) {
          skipLink.addEventListener('click', function(e) {
            e.preventDefault();
            mainContent.focus();
            mainContent.scrollIntoView({ behavior: 'smooth' });
          });
        }
      });
    </script>
  </body>
</html>
